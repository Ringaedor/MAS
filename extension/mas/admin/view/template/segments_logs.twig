{{ header }}{{ column_left }}

<div id="content">
  <div class="page-header pb-0 mb-0">
    <div class="container-fluid">
      <div class="float-end">
        <a href="{{ back }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> {{ button_back }}</a>
        <a href="{{ builder }}" class="btn btn-primary"><i class="fas fa-magic"></i> {{ text_segment_builder }}</a>
        <a href="{{ add }}" class="btn btn-success"><i class="fas fa-plus"></i> {{ button_add }}</a>
      </div>
      <h1>{{ text_materialization_logs }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li class="breadcrumb-item"><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="container-fluid logs-container pb-0">
    {% if error %}
      <div class="alert alert-danger alert-dismissible fade show"><i class="fas fa-exclamation-triangle"></i> {{ error }}</div>
    {% endif %}
    {% if success %}
      <div class="alert alert-success alert-dismissible fade show"><i class="fas fa-check"></i> {{ success }}</div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-sm-6 col-xl-3">
        <div class="card bg-gradient-primary text-white text-center mb-2 shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-server fa-2x mb-2"></i>
            <div class="fs-2 fw-bold" id="total-logs">{{ logs|length }}</div>
            <div>{{ text_total_logs|default('Total Logs') }}</div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-xl-3">
        <div class="card bg-gradient-success text-white text-center mb-2 shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-check-circle fa-2x mb-2"></i>
            <div class="fs-2 fw-bold" id="success-logs">{{ logs|filter(log => log.status == 'success')|length }}</div>
            <div>{{ text_success_logs|default('Successful') }}</div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-xl-3">
        <div class="card bg-gradient-danger text-white text-center mb-2 shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <div class="fs-2 fw-bold" id="failed-logs">{{ logs|filter(log => log.status == 'failed')|length }}</div>
            <div>{{ text_failed_logs|default('Failed') }}</div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-xl-3">
        <div class="card bg-gradient-info text-white text-center mb-2 shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-sync-alt fa-2x mb-2"></i>
            <div class="fs-2 fw-bold" id="running-logs">{{ logs|filter(log => log.status == 'running')|length }}</div>
            <div>{{ text_running_logs|default('Running') }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Filter Panel -->
    <div class="card mb-3 mas-filter-panel">
      <div class="card-body">
        <form id="logs-filter-form" method="get" class="row g-3 align-items-end">
          <input type="hidden" name="user_token" value="{{ user_token }}">
          
          <div class="col-md-3">
            <label class="form-label">{{ text_status }}</label>
            <select name="filter_status" class="form-select">
              {% for value, label in status_options %}
                <option value="{{ value }}"{% if value==filter_status %} selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="col-md-2">
            <label class="form-label">{{ text_from_date }}</label>
            <input type="date" name="filter_date_from" value="{{ filter_date_from }}" class="form-control">
          </div>
          
          <div class="col-md-2">
            <label class="form-label">{{ text_to_date }}</label>
            <input type="date" name="filter_date_to" value="{{ filter_date_to }}" class="form-control">
          </div>
          
          <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> {{ button_filter }}</button>
          </div>
          
          <div class="col-md-2 d-grid">
            <button type="button" id="clear-filters" class="btn btn-outline-secondary"><i class="fas fa-times"></i> {{ text_clear_filters }}</button>
          </div>
          
          <div class="col-md-1 d-grid">
            <button type="button" id="refresh-logs" class="btn btn-outline-info" title="{{ text_refresh }}"><i class="fas fa-sync-alt"></i></button>
          </div>
        </form>
      </div>
      <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
        <small class="text-muted">{{ text_auto_refresh|default('Auto-refresh every 30 seconds') }}</small>
        <a href="{{ ajax_export_logs }}" class="btn btn-outline-success btn-sm" id="export-logs-btn">
          <i class="fas fa-file-export"></i> {{ text_export_logs|default('Export Logs') }}
        </a>
      </div>
    </div>

    <!-- Logs Table -->
    <div class="card shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span>
          <i class="fas fa-server"></i> {{ text_materialization_logs }}
          <span class="badge bg-primary">{{ logs|length }}</span>
        </span>
        <div class="btn-group btn-group-sm">
          <button type="button" id="auto-refresh-toggle" class="btn btn-outline-secondary">
            <i class="fas fa-pause"></i> {{ text_pause_refresh|default('Pause Refresh') }}
          </button>
          <button type="button" id="clear-all-logs" class="btn btn-outline-danger">
            <i class="fas fa-trash"></i> {{ text_clear_all|default('Clear All') }}
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        {% if logs %}
        <div class="table-responsive">
          <table class="table table-hover table-sm mas-logs-table mb-0">
            <thead>
              <tr>
                <th width="60">ID</th>
                <th>{{ text_segment_name|default('Segment') }}</th>
                <th width="100">{{ text_status }}</th>
                <th width="100" class="text-end">{{ text_customers }}</th>
                <th width="120">{{ text_started|default('Started') }}</th>
                <th width="120">{{ text_completed|default('Completed') }}</th>
                <th width="80">{{ text_duration|default('Duration') }}</th>
                <th width="120">{{ text_actions }}</th>
              </tr>
            </thead>
            <tbody id="logs-table-body">
              {% for log in logs %}
              <tr data-log-id="{{ log.log_id }}" data-status="{{ log.status }}">
                <td>{{ log.log_id }}</td>
                <td>
                  <strong>{{ log.segment_name }}</strong>
                  {% if log.error_message %}
                    <div class="small text-danger mt-1">
                      <i class="fas fa-exclamation-circle"></i> {{ log.error_message|slice(0, 50) }}{% if log.error_message|length > 50 %}...{% endif %}
                    </div>
                  {% endif %}
                </td>
                <td>
                  <span class="mas-materialization-status {{ log.status_class }}">
                    {% if log.status == 'running' %}
                      <i class="fas fa-spinner fa-spin"></i>
                    {% elseif log.status == 'success' %}
                      <i class="fas fa-check"></i>
                    {% elseif log.status == 'failed' %}
                      <i class="fas fa-times"></i>
                    {% elseif log.status == 'cancelled' %}
                      <i class="fas fa-ban"></i>
                    {% endif %}
                    {{ log.status_label }}
                  </span>
                </td>
                <td class="text-end">{{ log.customers_count }}</td>
                <td>{{ log.started_at }}</td>
                <td>{{ log.completed_at ?: '-' }}</td>
                <td>{{ log.duration ?: '-' }}</td>
                <td>
                  <div class="btn-group btn-group-sm">
                    {% if log.status == 'failed' %}
                      <button type="button" class="btn btn-outline-warning retry-btn" data-log-id="{{ log.log_id }}">
                        <i class="fas fa-redo"></i> {{ text_retry|default('Retry') }}
                      </button>
                    {% endif %}
                    {% if log.error_message %}
                      <button type="button" class="btn btn-outline-danger view-error-btn" data-error="{{ log.error_message }}">
                        <i class="fas fa-exclamation-triangle"></i> {{ text_error|default('Error') }}
                      </button>
                    {% endif %}
                    {% if log.status == 'running' %}
                      <button type="button" class="btn btn-outline-secondary cancel-btn" data-log-id="{{ log.log_id }}">
                        <i class="fas fa-stop"></i> {{ text_cancel|default('Cancel') }}
                      </button>
                    {% endif %}
                    <button type="button" class="btn btn-outline-info view-details-btn" data-log-id="{{ log.log_id }}">
                      <i class="fas fa-eye"></i> {{ text_details|default('Details') }}
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="mas-segments-empty-state my-5 text-center">
            <i class="fas fa-database fa-4x mb-3"></i>
            <h4>{{ text_no_logs|default('No logs found') }}</h4>
            <p class="text-muted">{{ text_no_logs_description|default('No materialization activity has been recorded yet.') }}</p>
          </div>
        {% endif %}
      </div>
      {% if pagination %}
      <div class="card-footer d-flex justify-content-end pt-2 pb-1">
        {{ pagination }}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Error Details Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="errorModalLabel">{{ text_error_details|default('Error Details') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre id="error-content" class="bg-light p-3 border rounded"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ button_cancel }}</button>
        <button type="button" class="btn btn-primary" id="copy-error">
          <i class="fas fa-copy"></i> {{ text_copy|default('Copy') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">{{ text_log_details|default('Log Details') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="details-content">
          <div class="text-center py-3">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ button_cancel }}</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  let autoRefreshInterval = null;
  let autoRefreshEnabled = true;

  // Auto-refresh functionality
  function startAutoRefresh() {
    if (autoRefreshInterval) return;
    
    autoRefreshInterval = setInterval(function() {
      if (autoRefreshEnabled) {
        refreshLogs();
      }
    }, 30000); // 30 seconds
  }

  function stopAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }

  function refreshLogs() {
    const currentUrl = new URL(window.location);
    
    $.ajax({
      url: currentUrl.href,
      type: 'GET',
      dataType: 'html',
      success: function(response) {
        const newTableBody = $(response).find('#logs-table-body').html();
        if (newTableBody) {
          $('#logs-table-body').html(newTableBody);
          updateStatistics();
          showNotification('{{ text_logs_refreshed|default("Logs refreshed") }}', 'info');
        }
      },
      error: function() {
        showNotification('{{ text_refresh_error|default("Error refreshing logs") }}', 'danger');
      }
    });
  }

  function updateStatistics() {
    const totalLogs = $('#logs-table-body tr').length;
    const successLogs = $('#logs-table-body tr[data-status="success"]').length;
    const failedLogs = $('#logs-table-body tr[data-status="failed"]').length;
    const runningLogs = $('#logs-table-body tr[data-status="running"]').length;

    $('#total-logs').text(totalLogs);
    $('#success-logs').text(successLogs);
    $('#failed-logs').text(failedLogs);
    $('#running-logs').text(runningLogs);
  }

  // Event handlers
  $('#auto-refresh-toggle').on('click', function() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const $this = $(this);
    
    if (autoRefreshEnabled) {
      $this.html('<i class="fas fa-pause"></i> {{ text_pause_refresh|default("Pause Refresh") }}');
      $this.removeClass('btn-outline-success').addClass('btn-outline-secondary');
    } else {
      $this.html('<i class="fas fa-play"></i> {{ text_resume_refresh|default("Resume Refresh") }}');
      $this.removeClass('btn-outline-secondary').addClass('btn-outline-success');
    }
  });

  $('#refresh-logs').on('click', function() {
    refreshLogs();
  });

  $('#clear-filters').on('click', function() {
    $('#logs-filter-form')[0].reset();
    $('#logs-filter-form').submit();
  });

  // Retry functionality
  $(document).on('click', '.retry-btn', function() {
    const logId = $(this).data('log-id');
    const $btn = $(this);
    
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> {{ text_retrying|default("Retrying...") }}');
    
    $.ajax({
      url: '{{ ajax_retry_materialization|default("extension/mas/segments.retry_materialization") }}',
      type: 'POST',
      data: {
        log_id: logId,
        user_token: '{{ user_token }}'
      },
      dataType: 'json',
      success: function(response) {
        if (response.success) {
          showNotification(response.message || '{{ text_retry_started|default("Retry started") }}', 'success');
          setTimeout(refreshLogs, 2000);
        } else {
          showNotification(response.error || '{{ text_retry_failed|default("Retry failed") }}', 'danger');
        }
      },
      error: function() {
        showNotification('{{ text_retry_error|default("Error starting retry") }}', 'danger');
      },
      complete: function() {
        $btn.prop('disabled', false).html('<i class="fas fa-redo"></i> {{ text_retry }}');
      }
    });
  });

  // Cancel functionality
  $(document).on('click', '.cancel-btn', function() {
    const logId = $(this).data('log-id');
    
    if (confirm('{{ text_confirm_cancel|default("Are you sure you want to cancel this materialization?") }}')) {
      $.ajax({
        url: '{{ ajax_cancel_materialization|default("extension/mas/segments.cancel_materialization") }}',
        type: 'POST',
        data: {
          log_id: logId,
          user_token: '{{ user_token }}'
        },
        dataType: 'json',
        success: function(response) {
          if (response.success) {
            showNotification(response.message || '{{ text_cancelled|default("Materialization cancelled") }}', 'success');
            refreshLogs();
          } else {
            showNotification(response.error || '{{ text_cancel_failed|default("Cancel failed") }}', 'danger');
          }
        },
        error: function() {
          showNotification('{{ text_cancel_error|default("Error cancelling materialization") }}', 'danger');
        }
      });
    }
  });

  // Error details modal
  $(document).on('click', '.view-error-btn', function() {
    const errorMessage = $(this).data('error');
    $('#error-content').text(errorMessage);
    $('#errorModal').modal('show');
  });

  // Log details modal
  $(document).on('click', '.view-details-btn', function() {
    const logId = $(this).data('log-id');
    
    $('#details-content').html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin fa-2x"></i></div>');
    $('#detailsModal').modal('show');
    
    $.ajax({
      url: '{{ ajax_log_details|default("extension/mas/segments.log_details") }}',
      type: 'GET',
      data: {
        log_id: logId,
        user_token: '{{ user_token }}'
      },
      dataType: 'json',
      success: function(response) {
        if (response.success) {
          let html = `
            <div class="row">
              <div class="col-md-6">
                <h6>{{ text_general_info|default("General Information") }}</h6>
                <table class="table table-sm">
                  <tr><td><strong>Log ID:</strong></td><td>${response.details.log_id}</td></tr>
                  <tr><td><strong>Segment:</strong></td><td>${response.details.segment_name}</td></tr>
                  <tr><td><strong>Status:</strong></td><td><span class="mas-materialization-status ${response.details.status_class}">${response.details.status_label}</span></td></tr>
                  <tr><td><strong>Started:</strong></td><td>${response.details.started_at}</td></tr>
                  <tr><td><strong>Completed:</strong></td><td>${response.details.completed_at || '-'}</td></tr>
                  <tr><td><strong>Duration:</strong></td><td>${response.details.duration || '-'}</td></tr>
                  <tr><td><strong>Customers:</strong></td><td>${response.details.customers_count}</td></tr>
                </table>
              </div>
              <div class="col-md-6">
                <h6>{{ text_technical_details|default("Technical Details") }}</h6>
                <table class="table table-sm">
                  <tr><td><strong>Memory Used:</strong></td><td>${response.details.memory_used || '-'}</td></tr>
                  <tr><td><strong>CPU Time:</strong></td><td>${response.details.cpu_time || '-'}</td></tr>
                  <tr><td><strong>Query Count:</strong></td><td>${response.details.query_count || '-'}</td></tr>
                  <tr><td><strong>Process ID:</strong></td><td>${response.details.process_id || '-'}</td></tr>
                </table>
              </div>
            </div>`;
          
          if (response.details.error_message) {
            html += `
              <div class="mt-3">
                <h6>{{ text_error_message|default("Error Message") }}</h6>
                <pre class="bg-light p-3 border rounded text-danger">${response.details.error_message}</pre>
              </div>`;
          }
          
          $('#details-content').html(html);
        } else {
          $('#details-content').html('<div class="text-danger">{{ text_details_error|default("Error loading details") }}</div>');
        }
      },
      error: function() {
        $('#details-content').html('<div class="text-danger">{{ text_details_error|default("Error loading details") }}</div>');
      }
    });
  });

  // Copy error to clipboard
  $('#copy-error').on('click', function() {
    const errorText = $('#error-content').text();
    navigator.clipboard.writeText(errorText).then(function() {
      showNotification('{{ text_error_copied|default("Error copied to clipboard") }}', 'success');
    });
  });

  // Export logs
  $('#export-logs-btn').on('click', function(e) {
    e.preventDefault();
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('export', '1');
    window.location = currentUrl.href;
  });

  // Clear all logs
  $('#clear-all-logs').on('click', function() {
    if (confirm('{{ text_confirm_clear_all|default("Are you sure you want to clear all logs? This action cannot be undone.") }}')) {
      $.ajax({
        url: '{{ ajax_clear_logs|default("extension/mas/segments.clear_logs") }}',
        type: 'POST',
        data: { user_token: '{{ user_token }}' },
        dataType: 'json',
        success: function(response) {
          if (response.success) {
            showNotification(response.message || '{{ text_logs_cleared|default("All logs cleared") }}', 'success');
            location.reload();
          } else {
            showNotification(response.error || '{{ text_clear_failed|default("Clear failed") }}', 'danger');
          }
        },
        error: function() {
          showNotification('{{ text_clear_error|default("Error clearing logs") }}', 'danger');
        }
      });
    }
  });

  function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'danger' ? 'alert-danger' : 
                      type === 'info' ? 'alert-info' : 'alert-warning';
    
    const alert = $(`
      <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
        <i class="fas fa-${type === 'success' ? 'check' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `);
    
    $('body').append(alert);
    setTimeout(() => alert.alert('close'), 5000);
  }

  // Initialize
  startAutoRefresh();
  
  // Stop auto-refresh when page is hidden
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      stopAutoRefresh();
    } else {
      startAutoRefresh();
    }
  });

})();
</script>

{{ footer }}
