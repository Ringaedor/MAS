{{ header }}{{ column_left }}

<div id="content">
  <div class="page-header pb-0 mb-0">
    <div class="container-fluid">
      <div class="float-end">
        <a href="{{ back }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> {{ button_back }}</a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
          <i class="fas fa-plus"></i> {{ text_add_schedule|default('Add Schedule') }}
        </button>
      </div>
      <h1>{{ text_scheduler|default('Scheduler') }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li class="breadcrumb-item"><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="container-fluid scheduler-container pb-0">
    {% if error %}
      <div class="alert alert-danger alert-dismissible fade show"><i class="fas fa-exclamation-triangle"></i> {{ error }}</div>
    {% endif %}
    {% if success %}
      <div class="alert alert-success alert-dismissible fade show"><i class="fas fa-check"></i> {{ success }}</div>
    {% endif %}

    <!-- Scheduler Stats -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-gradient-primary text-white text-center shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <div class="fs-2 fw-bold">{{ scheduled_jobs|filter(job => job.status == 'active')|length }}</div>
            <div>{{ text_active_schedules|default('Active Schedules') }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-gradient-success text-white text-center shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-play fa-2x mb-2"></i>
            <div class="fs-2 fw-bold">{{ scheduled_jobs|length }}</div>
            <div>{{ text_total_schedules|default('Total Schedules') }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-gradient-warning text-dark text-center shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-pause fa-2x mb-2"></i>
            <div class="fs-2 fw-bold">{{ scheduled_jobs|filter(job => job.status == 'paused')|length }}</div>
            <div>{{ text_paused_schedules|default('Paused') }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-gradient-danger text-white text-center shadow-sm">
          <div class="card-body py-3">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <div class="fs-2 fw-bold">{{ scheduled_jobs|filter(job => job.status == 'error')|length }}</div>
            <div>{{ text_error_schedules|default('Errors') }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scheduled Jobs Table -->
    <div class="card shadow-sm">
      <div class="card-header">
        <span><i class="fas fa-calendar-alt"></i> {{ text_scheduled_jobs|default('Scheduled Jobs') }}</span>
      </div>
      <div class="card-body p-0">
        {% if scheduled_jobs %}
        <div class="table-responsive">
          <table class="table table-hover table-sm mb-0">
            <thead>
              <tr>
                <th>{{ text_segment }}</th>
                <th>{{ text_schedule }}</th>
                <th>{{ text_next_run|default('Next Run') }}</th>
                <th>{{ text_last_run|default('Last Run') }}</th>
                <th>{{ text_status }}</th>
                <th>{{ text_actions }}</th>
              </tr>
            </thead>
            <tbody>
              {% for job in scheduled_jobs %}
              <tr data-job-id="{{ job.job_id }}">
                <td>
                  <strong>{{ job.segment_name }}</strong>
                  <small class="text-muted d-block">ID: {{ job.segment_id }}</small>
                </td>
                <td>
                  <span class="badge bg-info">{{ job.schedule_type|title }}</span>
                  <small class="text-muted d-block">{{ job.schedule_value }}</small>
                </td>
                <td>{{ job.next_run }}</td>
                <td>{{ job.last_run ?: '-' }}</td>
                <td>
                  <span class="badge {{ job.status_class }}">{{ job.status_label }}</span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-success run-now-btn" data-job-id="{{ job.job_id }}">
                      <i class="fas fa-play"></i> {{ text_run_now|default('Run Now') }}
                    </button>
                    <button type="button" class="btn btn-outline-primary edit-schedule-btn" data-job-id="{{ job.job_id }}">
                      <i class="fas fa-edit"></i> {{ button_edit }}
                    </button>
                    <button type="button" class="btn btn-outline-danger delete-schedule-btn" data-job-id="{{ job.job_id }}">
                      <i class="fas fa-trash"></i> {{ button_delete }}
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
          <h5>{{ text_no_schedules|default('No schedules configured') }}</h5>
          <p class="text-muted">{{ text_add_first_schedule|default('Add your first schedule to automate segment materialization') }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addScheduleLabel">{{ text_add_schedule|default('Add Schedule') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="add-schedule-form">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">{{ text_segment }} <span class="text-danger">*</span></label>
            <select class="form-select" name="segment_id" required>
              <option value="">{{ text_select_segment|default('Select Segment') }}</option>
              {% for segment in available_segments %}
              <option value="{{ segment.segment_id }}">{{ segment.name }} ({{ segment.type|title }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">{{ text_schedule_type|default('Schedule Type') }} <span class="text-danger">*</span></label>
            <select class="form-select" name="schedule_type" required>
              <option value="">{{ text_select_type|default('Select Type') }}</option>
              {% for value, label in schedule_types %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3" id="schedule-value-container">
            <label class="form-label">{{ text_schedule_value|default('Schedule Value') }} <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="schedule_value" placeholder="{{ text_schedule_value_placeholder|default('Enter schedule value') }}">
            <div class="form-text" id="schedule-help"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ button_cancel }}</button>
          <button type="submit" class="btn btn-primary">{{ text_add_schedule|default('Add Schedule') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  
  // Schedule type change handler
  $('[name="schedule_type"]').on('change', function() {
    const type = $(this).val();
    const valueInput = $('[name="schedule_value"]');
    const helpText = $('#schedule-help');
    
    switch(type) {
      case 'hourly':
        valueInput.attr('placeholder', '1-23').attr('type', 'number').attr('min', '1').attr('max', '23');
        helpText.text('{{ text_hourly_help|default("Hours between runs (1-23)") }}');
        break;
      case 'daily':
        valueInput.attr('placeholder', 'HH:MM').attr('type', 'time');
        helpText.text('{{ text_daily_help|default("Time of day to run (24-hour format)") }}');
        break;
      case 'weekly':
        valueInput.replaceWith(`
          <select class="form-select" name="schedule_value">
            <option value="0">{{ text_sunday|default("Sunday") }}</option>
            <option value="1">{{ text_monday|default("Monday") }}</option>
            <option value="2">{{ text_tuesday|default("Tuesday") }}</option>
            <option value="3">{{ text_wednesday|default("Wednesday") }}</option>
            <option value="4">{{ text_thursday|default("Thursday") }}</option>
            <option value="5">{{ text_friday|default("Friday") }}</option>
            <option value="6">{{ text_saturday|default("Saturday") }}</option>
          </select>
        `);
        helpText.text('{{ text_weekly_help|default("Day of week to run") }}');
        break;
      case 'monthly':
        valueInput.attr('placeholder', '1-31').attr('type', 'number').attr('min', '1').attr('max', '31');
        helpText.text('{{ text_monthly_help|default("Day of month to run (1-31)") }}');
        break;
      case 'cron':
        valueInput.attr('placeholder', '0 2 * * *').attr('type', 'text');
        helpText.text('{{ text_cron_help|default("Cron expression (minute hour day month weekday)") }}');
        break;
      default:
        valueInput.attr('placeholder', '').attr('type', 'text');
        helpText.text('');
    }
  });

  // Add schedule form
  $('#add-schedule-form').on('submit', function(e) {
    e.preventDefault();
    
    const formData = $(this).serialize();
    
    $.ajax({
      url: '{{ ajax_add_schedule }}',
      type: 'POST',
      data: formData + '&user_token={{ user_token }}',
      dataType: 'json',
      success: function(response) {
        if (response.success) {
          showNotification(response.message, 'success');
          $('#addScheduleModal').modal('hide');
          location.reload();
        } else {
          showNotification(response.error, 'danger');
        }
      },
      error: function() {
        showNotification('{{ text_add_error|default("Error adding schedule") }}', 'danger');
      }
    });
  });

  // Run now button
  $(document).on('click', '.run-now-btn', function() {
    const jobId = $(this).data('job-id');
    const $btn = $(this);
    
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> {{ text_running|default("Running...") }}');
    
    $.ajax({
      url: '{{ ajax_run_now }}',
      type: 'POST',
      data: {
        job_id: jobId,
        user_token: '{{ user_token }}'
      },
      dataType: 'json',
      success: function(response) {
        if (response.success) {
          showNotification(response.message, 'success');
        } else {
          showNotification(response.error, 'danger');
        }
      },
      error: function() {
        showNotification('{{ text_run_error|default("Error running schedule") }}', 'danger');
      },
      complete: function() {
        $btn.prop('disabled', false).html('<i class="fas fa-play"></i> {{ text_run_now }}');
      }
    });
  });

  // Delete schedule
  $(document).on('click', '.delete-schedule-btn', function() {
    const jobId = $(this).data('job-id');
    
    if (confirm('{{ text_confirm_delete_schedule|default("Are you sure you want to delete this schedule?") }}')) {
      $.ajax({
        url: '{{ ajax_delete_schedule }}',
        type: 'POST',
        data: {
          job_id: jobId,
          user_token: '{{ user_token }}'
        },
        dataType: 'json',
        success: function(response) {
          if (response.success) {
            showNotification(response.message || '{{ text_schedule_deleted|default("Schedule deleted") }}', 'success');
            $(`tr[data-job-id="${jobId}"]`).fadeOut();
          } else {
            showNotification(response.error, 'danger');
          }
        },
        error: function() {
          showNotification('{{ text_delete_error|default("Error deleting schedule") }}', 'danger');
        }
      });
    }
  });

  function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'danger' ? 'alert-danger' : 'alert-info';
    
    const alert = $(`
      <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
        <i class="fas fa-${type === 'success' ? 'check' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `);
    
    $('body').append(alert);
    setTimeout(() => alert.alert('close'), 5000);
  }

})();
</script>

{{ footer }}
